version: "3.9"

###############################################################
# NETWORKS
###############################################################
networks:
  media_net:
    driver: bridge
  vpn_net:
    driver: bridge

###############################################################
# SERVICES
###############################################################
services:

  ###############################################################
  # GLUETUN (VPN)
  ###############################################################
  gluetun:
    image: qmcgaw/gluetun
    container_name: gluetun
    restart: unless-stopped
    networks:
      - vpn_net
    cap_add:
      - NET_ADMIN
    devices:
      - /dev/net/tun:/dev/net/tun
    environment:
      - VPN_SERVICE_PROVIDER=${VPN_SERVICE_PROVIDER}
      - OPENVPN_USER=${VPN_USER}
      - OPENVPN_PASSWORD=${VPN_PASSWORD}
      - SERVER_COUNTRIES=Switzerland
      - TZ=Europe/Brussels
      - FIREWALL_VPN_INPUT_PORTS=7878,8989,9696,8686,8787,6767,9091
      - VPN_HEALTHCHECK_NO_RESTART=true
    healthcheck:
      test: ["CMD-SHELL", "ping -c 1 1.1.1.1 || exit 1"]
      interval: 60s
      timeout: 10s
      retries: 3
      start_period: 20s
    labels:
      - com.centurylinklabs.watchtower.enable=false
      - autoheal=true


  ###############################################################
  # NGINX PROXY MANAGER (outside VPN)
  ###############################################################
  nginx-proxy-manager:
    image: jc21/nginx-proxy-manager:latest
    container_name: nginx-proxy-manager
    restart: unless-stopped
    networks:
      - media_net
      - vpn_net     # <-- IMPORTANT: allows NPM to reach Gluetun
    ports:
      - 80:80
      - 81:81
      - 443:443
    environment:
      - TZ=Europe/Brussels
    volumes:
      - /mnt/.ix-apps/app_mounts/npm/data:/data
      - /mnt/.ix-apps/app_mounts/npm/letsencrypt:/etc/letsencrypt
    healthcheck:
      test: ["CMD", "curl", "-fs", "http://localhost:81/login"]
      interval: 60s
      timeout: 10s
      retries: 3
      start_period: 20s
    labels:
      - com.centurylinklabs.watchtower.enable=true
      - autoheal=true


  ###############################################################
  # ARR SERVICES (inside Gluetun)
  ###############################################################

  radarr:
    image: lscr.io/linuxserver/radarr:latest
    container_name: radarr
    network_mode: "service:gluetun"
    depends_on:
      gluetun:
        condition: service_healthy
    environment:
      - PUID=1000
      - PGID=1000
      - TZ=Europe/Brussels
    volumes:
      - /mnt/.ix-apps/app_mounts/radarr/config:/config
      - /mnt/pool-main/media/movies:/movies
      - /mnt/pool-main/media/downloads:/downloads
    restart: unless-stopped
    labels:
      - com.centurylinklabs.watchtower.enable=true

  sonarr:
    image: lscr.io/linuxserver/sonarr:latest
    container_name: sonarr
    network_mode: "service:gluetun"
    depends_on:
      gluetun:
        condition: service_healthy
    environment:
      - PUID=1000
      - PGID=1000
      - TZ=Europe/Brussels
    volumes:
      - /mnt/.ix-apps/app_mounts/sonarr/config:/config
      - /mnt/pool-main/media/series:/tv
      - /mnt/pool-main/media/downloads:/downloads
    restart: unless-stopped
    labels:
      - com.centurylinklabs.watchtower.enable=true

  lidarr:
    image: lscr.io/linuxserver/lidarr:latest
    container_name: lidarr
    network_mode: "service:gluetun"
    depends_on:
      gluetun:
        condition: service_healthy
    environment:
      - PUID=1000
      - PGID=1000
      - TZ=Europe/Brussels
    volumes:
      - /mnt/.ix-apps/app_mounts/lidarr/config:/config
      - /mnt/pool-main/media/music:/music
      - /mnt/pool-main/media/downloads:/downloads
    restart: unless-stopped
    labels:
      - com.centurylinklabs.watchtower.enable=true

  readarr:
    image: lscr.io/linuxserver/readarr:latest
    container_name: readarr
    network_mode: "service:gluetun"
    depends_on:
      gluetun:
        condition: service_healthy
    environment:
      - PUID=1000
      - PGID=1000
      - TZ=Europe/Brussels
    volumes:
      - /mnt/.ix-apps/app_mounts/readarr/config:/config
      - /mnt/pool-main/media/books:/books
      - /mnt/pool-main/media/downloads:/downloads
    res
