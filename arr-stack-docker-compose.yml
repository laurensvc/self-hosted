version: "3.8"

###############################################################
# NETWORKS
###############################################################
networks:
  media_net:
    driver: bridge
  vpn_net:
    driver: bridge

###############################################################
# SERVICES
###############################################################
services:

  ###############################################################
  # GLUETUN (VPN)
  ###############################################################
  gluetun:
    image: qmcgaw/gluetun
    container_name: gluetun
    restart: unless-stopped
    networks:
      - vpn_net
    ports:
      - 7878:7878     # Radarr
      - 8989:8989     # Sonarr
      - 9696:9696     # Prowlarr
      - 8686:8686     # Lidarr
      - 6767:6767     # Bazarr
      - 9091:9091     # Transmission
      - 6789:6789     # NZBGet
    cap_add:
      - NET_ADMIN
    devices:
      - /dev/net/tun:/dev/net/tun
    environment:
      - VPN_SERVICE_PROVIDER=${VPN_SERVICE_PROVIDER}
      - OPENVPN_USER=${VPN_USER}
      - OPENVPN_PASSWORD=${VPN_PASSWORD}
      - SERVER_COUNTRIES=Switzerland
      - TZ=Europe/Brussels
      - FIREWALL_VPN_INPUT_PORTS=7878,8989,9696,8686,6767,9091,6789
      - VPN_HEALTHCHECK_NO_RESTART=true
    healthcheck:
      test: ["CMD-SHELL", "ping -c 1 1.1.1.1 || exit 1"]
      interval: 60s
      timeout: 10s
      retries: 3
      start_period: 20s
    labels:
      - com.centurylinklabs.watchtower.enable=false
      # - autoheal=true   # REMOVE for stability!


  ###############################################################
  # NGINX PROXY MANAGER (optional)
  ###############################################################
  nginx-proxy-manager:
    image: jc21/nginx-proxy-manager:latest
    container_name: nginx-proxy-manager
    restart: unless-stopped
    networks:
      - media_net
      - vpn_net
    ports:
      - 80:80
      - 81:81
      - 443:443
    environment:
      - TZ=Europe/Brussels
    volumes:
      - /mnt/.ix-apps/app_mounts/npm/data:/data
      - /mnt/.ix-apps/app_mounts/npm/letsencrypt:/etc/letsencrypt
    healthcheck:
      test: ["CMD", "curl", "-fs", "http://localhost:81/login"]
      interval: 60s
      timeout: 10s
      retries: 3
      start_period: 20s
    labels:
      - com.centurylinklabs.watchtower.enable=true
      # - autoheal=true   # REMOVE for stability!


  ###############################################################
  # ARR SERVICES (inside Gluetun)
  ###############################################################
  radarr:
    image: lscr.io/linuxserver/radarr:latest
    container_name: radarr
    network_mode: "service:gluetun"
    depends_on:
      gluetun:
        condition: service_healthy
    environment:
      - PUID=1000
      - PGID=1000
      - TZ=Europe/Brussels
    volumes:
      - /mnt/.ix-apps/app_mounts/radarr/config:/config
      - /mnt/pool-main/plex-media/Movies:/movies
      - /mnt/pool-main/plex-media/downloads:/downloads
    restart: unless-stopped

  sonarr:
    image: lscr.io/linuxserver/sonarr:latest
    container_name: sonarr
    network_mode: "service:gluetun"
    depends_on:
      gluetun:
        condition: service_healthy
    environment:
      - PUID=1000
      - PGID=1000
      - TZ=Europe/Brussels
    volumes:
      - /mnt/.ix-apps/app_mounts/sonarr/config:/config
      - /mnt/pool-main/plex-media/Series:/series
      - /mnt/pool-main/plex-media/downloads:/downloads
    restart: unless-stopped

  lidarr:
    image: lscr.io/linuxserver/lidarr:latest
    container_name: lidarr
    network_mode: "service:gluetun"
    depends_on:
      gluetun:
        condition: service_healthy
    environment:
      - PUID=1000
      - PGID=1000
      - TZ=Europe/Brussels
    volumes:
      - /mnt/.ix-apps/app_mounts/lidarr/config:/config
      - /mnt/pool-main/plex-media/Music:/music
      - /mnt/pool-main/plex-media/downloads:/downloads
    restart: unless-stopped

  prowlarr:
    image: lscr.io/linuxserver/prowlarr:latest
    container_name: prowlarr
    network_mode: "service:gluetun"
    depends_on:
      gluetun:
        condition: service_healthy
    environment:
      - PUID=1000
      - PGID=1000
      - TZ=Europe/Brussels
    volumes:
      - /mnt/.ix-apps/app_mounts/prowlarr/config:/config
    restart: unless-stopped

  bazarr:
    image: lscr.io/linuxserver/bazarr:latest
    container_name: bazarr
    network_mode: "service:gluetun"
    depends_on:
      gluetun:
        condition: service_healthy
    environment:
      - PUID=1000
      - PGID=1000
      - TZ=Europe/Brussels
    volumes:
      - /mnt/.ix-apps/app_mounts/bazarr/config:/config
      - /mnt/pool-main/plex-media/Movies:/movies
      - /mnt/pool-main/plex-media/Series:/series
    restart: unless-stopped


  ###############################################################
  # OVERSEERR (outside VPN)
  ###############################################################
  overseerr:
    image: sctx/overseerr:latest
    container_name: overseerr
    restart: unless-stopped
    networks:
      - media_net
    ports:
      - 5055:5055
    environment:
      - TZ=Europe/Brussels
    volumes:
      - /mnt/.ix-apps/app_mounts/overseerr/config:/app/config
    healthcheck:
      test: ["CMD", "node", "--version"]
      interval: 5m
      timeout: 10s
      retries: 3
      start_period: 60s
    labels:
      - com.centurylinklabs.watchtower.enable=true
      # - autoheal=true   # REMOVE for stability!


  ###############################################################
  # TRANSMISSION & NZBGET (inside Gluetun)
  ###############################################################
  transmission:
    image: lscr.io/linuxserver/transmission:latest
    container_name: transmission
    network_mode: "service:gluetun"
    depends_on:
      gluetun:
        condition: service_healthy
    environment:
      - PUID=1000
      - PGID=1000
      - TZ=Europe/Brussels
      - USER=admin
      - PASS=${TRANSMISSION_PASSWORD}
    volumes:
      - /mnt/.ix-apps/app_mounts/transmission/config:/config
      - /mnt/pool-main/plex-media/downloads:/downloads
    restart: unless-stopped

  nzbget:
    image: lscr.io/linuxserver/nzbget:latest
    container_name: nzbget
    network_mode: "service:gluetun"
    depends_on:
      gluetun:
        condition: service_healthy
    environment:
      - PUID=1000
      - PGID=1000
      - TZ=Europe/Brussels
      - NZBGET_USER=admin
      - NZBGET_PASS=${NZBGET_PASSWORD}
    volumes:
      - /mnt/.ix-apps/app_mounts/nzbget/config:/config
      - /mnt/pool-main/plex-media/downloads:/downloads
    restart: unless-stopped


  ###############################################################
  # RECYCLARR
  ###############################################################
  recyclarr:
    image: recyclarr/recyclarr:latest
    container_name: recyclarr
    restart: unless-stopped
    networks:
      - media_net
    depends_on:
      - radarr
      - sonarr
    environment:
      - TZ=Europe/Brussels
    volumes:
      - /mnt/.ix-apps/app_mounts/recyclarr/config:/config


  ###############################################################
  # WATCHTOWER
  ###############################################################
  watchtower:
    image: containrrr/watchtower:latest
    container_name: watchtower
    restart: unless-stopped
    volumes:
      - /var/run/docker.sock:/var/run/docker.sock
    environment:
      - TZ=Europe/Brussels
      - WATCHTOWER_SCHEDULE=0 0 3 * * 0
      - WATCHTOWER_CLEANUP=true
      - WATCHTOWER_LABEL_ENABLE=true


  ###############################################################
  # AUTOHEAL
  ###############################################################
  autoheal:
    image: willfarrell/autoheal:latest
    container_name: autoheal
    restart: unless-stopped
    volumes:
      - /var/run/docker.sock:/var/run/docker.sock
    environment:
      - AUTOHEAL_CONTAINER_LABEL=autoheal
      - AUTOHEAL_INTERVAL=30
      - AUTOHEAL_START_PERIOD=300
      - AUTOHEAL_DEFAULT_STOP_TIMEOUT=30
